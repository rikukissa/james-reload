module.exports=function(e){var t,r,n,o,u,i,s,a;return null==e&&(e={}),o=require("fs"),u=require("http"),a=require("websocket").server,e.proxyPort=e.proxyPort||e.proxy||9002,e.srcPort=e.srcPort||e.reload||9001,e.keepReconnecting=e.keepReconnecting||!0,e.reloadAfterReconnect=e.reloadAfterReconnect||!0,e.debug=e.debug||!1,r=(""+o.readFileSync(__dirname+"/client.js")).replace("__opts__",JSON.stringify(e)),t=function(e){return e.replace("</body>","<script>"+r+"</script></body>")},s=u.createServer(function(r,n){var o;return o=function(){var i;return i=u.request({hostname:"localhost",port:e.proxyPort,method:r.method,path:r.url,headers:r.headers},function(e){var r,o,u;return r=e.headers["content-type"],u=(null!=r?r.toLowerCase().indexOf("text/html"):void 0)>-1,o="",e.on("data",function(e){return u?o+=e:n.write(e,"binary")}),e.on("end",function(){return u?n.end(t(o),"utf-8"):n.end()}),u?void 0:n.writeHead(e.statusCode,e.headers)}),r.on("data",function(e){return i.write(e)}),r.on("end",function(){return i.end()}),i.on("error",function(){return e.keepReconnecting?o():void 0})},o()}),s.listen(e.srcPort),a=new a({httpServer:s,autoAcceptConnections:!1}),n=[],a.on("request",function(e){var t;return t=e.accept(null,e.origin),n.push(t),t.on("close",function(){return n.splice(n.indexOf(t),1)})}),i=function(e){var t,r,o,u;for(null==e&&(e={}),e.stylesheetsOnly=e.stylesheetsOnly||!1,u=[],r=0,o=n.length;o>r;r++)t=n[r],u.push(t.sendUTF(e.stylesheetsOnly?"refresh":"reload"));return u}};