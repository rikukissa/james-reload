var __slice=[].slice;module.exports=function(e){var r,t,n,o,u,c,i,l,s,a;return null==e&&(e={}),u=require("fs"),c=require("http"),a=require("websocket").server,n=require("colors"),e.proxyPort=e.proxyPort||e.reload||9002,e.srcPort=e.srcPort||e.proxy||9001,e.keepReconnecting=e.keepReconnecting||!0,e.reloadAfterReconnect=e.reloadAfterReconnect||!0,e.debug=e.debug||!1,t=(""+u.readFileSync(__dirname+"/client.js")).replace("__opts__",JSON.stringify(e)),r=function(e){return e.replace("</body>","<script>"+t+"</script></body>")},i=function(){var e;return e=arguments.length>=1?__slice.call(arguments,0):[],console.log.apply(console,["James-reload:"].concat(e))},s=c.createServer(function(t,n){var o;return o=function(){var u;return u=c.request({hostname:"localhost",port:e.srcPort,method:t.method,path:t.url,headers:t.headers},function(e){var t,o,u;return t=e.headers["content-type"],u=(null!=t?t.toLowerCase().indexOf("text/html"):void 0)>-1,o="",e.on("data",function(e){return u?o+=e:n.write(e,"binary")}),e.on("end",function(){return u?n.end(r(o),"utf-8"):n.end()}),u?void 0:n.writeHead(e.statusCode,e.headers)}),t.on("data",function(e){return u.write(e)}),t.on("end",function(){return u.end()}),u.on("error",function(r){return i("Proxy request failed:".red,r.message),e.keepReconnecting?(i("Reconnecting".yellow),o()):void 0})},o()}),s.listen(e.proxyPort),a=new a({httpServer:s,autoAcceptConnections:!1}),o=[],a.on("request",function(e){var r;return r=e.accept(null,e.origin),o.push(r),r.on("close",function(){return o.splice(o.indexOf(r),1)})}),l=function(e){var r,t,n,u;for(null==e&&(e={}),e.stylesheetsOnly=e.stylesheetsOnly||!1,t=e.stylesheetsOnly?"refresh":"reload",n=0,u=o.length;u>n;n++)r=o[n],r.sendUTF(t);return i(t.green)}};